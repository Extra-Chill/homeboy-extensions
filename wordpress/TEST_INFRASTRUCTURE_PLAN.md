# WordPress Module - Test Infrastructure Implementation Plan

## Overview

This plan describes adding WordPress test infrastructure to the WordPress module, providing a centralized, zero-config testing and linting runtime for all WordPress projects.

### Key Principles

1. **Single Source of Truth**: WordPress core, test suite, and linting standards live in the module, not in individual projects
2. **Zero Friction**: Projects only need test files; all infrastructure provided by module
3. **Universal Standards**: All plugins/themes use same coding standards (PHPCS with WPCS)
4. **One-Time-Use Runtime**: WordPress runs ephemerally only during testing
5. **Consistent Platform**: All projects test and lint against same WordPress version and standards
6. **KISS Compliant**: Uses existing WordPress test suite and PHPCS patterns
7. **Platform-Agnostic**: Homeboy Core provides JSON only; modules parse their own settings

### Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                     homeboy-module-wordpress                   │
│  Runtime: Testing + Linting for WordPress ecosystem          │
├─────────────────────────────────────────────────────────────────┤
│                                                               │
│  Layer 1: Module Files                                        │
│  ├─ wordpress.json       (manifest + runtime config)           │
│  ├─ composer.json       (dependencies: wp-phpunit, phpcs)      │
│  ├─ phpcs.xml.dist     (universal coding standards)           │
│  └─ scripts/             (runtime scripts)                     │
│                                                               │
│  Layer 2: WordPress Runtime                                    │
│  ├─ Embedded core (from wp-phpunit)                           │
│  ├─ SQLite driver (in-memory)                                 │
│  ├─ Test bootstrap                                             │
│  └─ PHPCS standards (WPCS)                                    │
│                                                               │
│  Layer 3: Integration Points                                   │
│  ├─ build.sh           (existing - runs composer test)         │
│  ├─ homeboy test       (component & project testing)           │
│  ├─ composer lint      (PHPCS linting)                        │
│  └─ Module runtime     (test-runner.sh)                       │
│                                                               │
└─────────────────────────────────────────────────────────────────┘
```

### Homeboy Core Contract

Homeboy Core provides these environment variables to modules:

| Variable | Description | Example |
|----------|-------------|----------|
| `HOMEBOY_EXEC_CONTEXT_VERSION` | Exec context protocol version | `"1"` |
| `HOMEBOY_MODULE_ID` | Module ID from manifest | `"wordpress"` |
| `HOMEBOY_SETTINGS_JSON` | **JSON string** of merged settings | `{"database_type":"sqlite"}` |
| `HOMEBOY_MODULE_PATH` | Module filesystem path | `~/.config/homeboy/modules/wordpress` |
| `HOMEBOY_PROJECT_PATH` | Project base_path (if project context) | `~/projects/my-plugin` |
| `HOMEBOY_PROJECT_ID` | Project ID (if set) | `"my-plugin"` |
| `HOMEBOY_COMPONENT_ID` | Component ID (if set) | `"staging"` |
| `HOMEBOY_COMPONENT_PATH` | Component filesystem path (if set) | `~/components/my-plugin` |

**Important:** Modules must parse `HOMEBOY_SETTINGS_JSON` themselves using tools like jq. Homeboy Core does NOT expand individual `HOMEBOY_SETTINGS_*` environment variables.

---

## 1. Module Directory Structure

```
homeboy-modules/wordpress/
├── wordpress.json                          # Module manifest
├── composer.json                           # Dependencies (wp-phpunit, phpcs)
├── phpcs.xml.dist                         # Universal PHPCS config
├── vendor/                                # Generated by composer install
│   ├── wp-phpunit/
│   │   └── wp-phpunit/
│   │       ├── tests/phpunit/             # WordPress test suite
│   │       │   ├── includes/
│   │       │   │   ├── bootstrap.php
│   │       │   │   ├── factory.php
│   │       │   │   ├── functions.php
│   │       │   │   └── ...
│   │       │   └── data/
│   │       ├── wp-config-sample.php        # Config template
│   │       └── wordpress/                 # WordPress core files
│   │           ├── wp-settings.php
│   │           ├── wp-includes/
│   │           └── ...
│   ├── squizlabs/php_codesniffer/         # PHPCS
│   ├── wp-coding-standards/wpcs/         # WPCS
│   └── bin/
│       ├── phpunit                        # Test runner
│       └── phpcs                         # Linting tool
├── scripts/
│   ├── setup.sh                          # Initial setup (composer install)
│   ├── test-runner.sh                    # Main test execution script
│   └── generate-config.sh                # Generate wp-config.php
├── tests/
│   └── bootstrap.php                     # WordPress + plugin bootstrap
├── sqlitedb/
│   └── db.php                            # SQLite database driver
└── phpunit.xml.dist                      # PHPUnit configuration
```

---

## 2. Module Manifest (wordpress.json)

```json
{
  "name": "WordPress",
  "version": "1.0.0",

  "runtime": {
    "setup_command": "bash {{modulePath}}/scripts/setup.sh",
    "ready_check": "test -f {{modulePath}}/vendor/wp-phpunit/wp-phpunit/tests/phpunit/includes/bootstrap.php",
    "run_command": "bash {{modulePath}}/scripts/test-runner.sh"
  },

  "testing": {
    "supported_databases": ["sqlite", "mysql"],
    "default_database": "sqlite"
  },

  "commands": ["wp", "wp-test"],

  "settings": {
    "database_type": {
      "type": "select",
      "options": ["sqlite", "mysql"],
      "default": "sqlite",
      "description": "Database backend for tests (sqlite = in-memory, fastest)"
    },
    "mysql_host": {
      "type": "string",
      "default": "localhost",
      "description": "MySQL host (when using mysql database type)"
    },
    "mysql_database": {
      "type": "string",
      "default": "wordpress_test",
      "description": "MySQL database name (when using mysql database type)"
    },
    "mysql_user": {
      "type": "string",
      "default": "root",
      "description": "MySQL user (when using mysql database type)"
    },
    "mysql_password": {
      "type": "string",
      "default": "",
      "description": "MySQL password (when using mysql database type)"
    }
  }
}
```

---

## 3. Composer Configuration (composer.json)

```json
{
  "name": "homeboy/module-wordpress",
  "description": "WordPress module with embedded test infrastructure and linting",
  "type": "homeboy-module",
  "license": "GPL-2.0-or-later",

  "require": {
    "php": ">=7.4",
    "wp-phpunit/wp-phpunit": "^6.8"
  },

  "require-dev": {
    "phpunit/phpunit": "^9.0",
    "squizlabs/php_codesniffer": "^3.10",
    "wp-coding-standards/wpcs": "^3.1",
    "dealerdirect/phpcodesniffer-composer-installer": "^1.0"
  },

  "config": {
    "allow-plugins": {
      "dealerdirect/phpcodesniffer-composer-installer": true
    }
  },

  "scripts": {
    "setup": [
      "@composer install"
    ],
    "test": "phpunit --configuration={{modulePath}}/phpunit.xml.dist",
    "lint": "phpcs"
  }
}
```

**Key additions:**
- PHPCS dependencies for linting
- `composer lint` script for universal linting

---

## 4. Universal PHPCS Configuration (phpcs.xml.dist)

```xml
<?xml version="1.0"?>
<ruleset name="homeboy-wp-standard">
    <description>Universal PHPCS standard for all WordPress projects using Homeboy</description>

    <arg name="colors" value="true"/>
    <arg value="ps"/>

    <rule ref="WordPress">
        <exclude name="WordPress.WP.I18n.MissingTranslatorsComment"/>
        <exclude name="WordPress.WP.DeprecatedParameters"/>
    </rule>

    <exclude-pattern>*/vendor/*</exclude-pattern>
    <exclude-pattern>*/node_modules/*</exclude-pattern>
    <exclude-pattern>*/build/*</exclude-pattern>
    <exclude-pattern>*/dist/*</exclude-pattern>

    <arg name="extensions" value="php"/>
</ruleset>
```

**Design decisions:**
- Uses WordPress Coding Standards as base
- Includes reasonable exclusions for development directories
- Universal - no plugin/theme customization needed
- Provided by module, not required in projects

---

## 5. Runtime Scripts

### scripts/setup.sh
```bash
#!/bin/bash
set -euo pipefail

MODULE_PATH="${HOMEBOY_MODULE_PATH}"

echo "Setting up WordPress test infrastructure..."

# Install dependencies
cd "$MODULE_PATH"
composer install --quiet --no-interaction

echo "WordPress test infrastructure installed successfully"
echo "WP_TESTS_DIR: $MODULE_PATH/vendor/wp-phpunit/wp-phpunit/tests/phpunit"
echo "ABSPATH: $MODULE_PATH/vendor/wp-phpunit/wp-phpunit/wordpress"
echo "PHPCS available: composer lint"
```

### scripts/test-runner.sh

Supports both component-level and project-level testing:

**Component-level testing:**
- Lints single component with PHPCS
- Runs PHPUnit if component has tests/
- Fails fast if linting fails

**Project-level testing:**
- Lints ALL components in project
- Runs PHPUnit on components with tests/
- Reports per-component results

### scripts/generate-config.sh

Handles SQLite and MySQL database configuration for WordPress testing environment.

---

## 6. Bootstrap Files

### tests/bootstrap.php
Loads WordPress core and the plugin/theme being tested.

### phpunit.xml.dist
PHPUnit configuration pointing to module bootstrap.

---

## 7. SQLite Database Driver

### sqlitedb/db.php
Lightweight SQLite driver for in-memory database testing.

---

## 8. Project Requirements

### Minimal Project Structure
```
my-plugin/
├── my-plugin.php                    # Plugin main file
├── inc/                             # Plugin code
└── tests/                           # ONLY test files (no WordPress!)
    ├── test-sample.php
    └── (no bootstrap.php needed)
```

### What Projects DON'T Need:
- ❌ WordPress installation
- ❌ wp-config.php
- ❌ Database setup
- ❌ PHPCS configuration (phpcs.xml)
- ❌ PHPCS packages
- ❌ PHPUnit configuration
- ❌ Test bootstrap

### What Projects DO Need:
- ✅ Test files in `tests/` directory
- ✅ That's it!

---

## 9. Build Integration

The existing `build.sh` runs tests and linting:

```bash
# Build.sh runs these automatically:
composer lint        # PHPCS linting (module provides)
composer test        # PHPUnit tests (module provides)
```

---

## 10. Running Tests and Linting

### Component-Level Testing

```bash
# Test single component (lint + tests if exist)
homeboy test blocks-everywhere

# Debug mode
HOMEBOY_DEBUG=1 homeboy test blocks-everywhere
```

**Behavior:**
1. Lints component with PHPCS
2. Fails if linting errors
3. Runs PHPUnit if `tests/` exists
4. Skips PHPUnit if no tests

### Project-Level Testing

```bash
# Test entire project (all components)
homeboy test extra-chill

# Debug mode
HOMEBOY_DEBUG=1 homeboy test extra-chill
```

**Behavior:**
1. Lints ALL components in project
2. Fails fast if any component has linting errors
3. Runs PHPUnit on components with `tests/`
4. Reports per-component results

### Module Runtime

```bash
# Run WordPress module with custom settings
homeboy module run wordpress --component blocks-everywhere \
  --setting database_type=sqlite
```

### Composer Commands

```bash
# Lint current directory (uses module PHPCS)
composer lint

# Test current directory (uses module PHPUnit)
composer test
```

---

## 11. Version Management

### Module Version = WordPress Version

```json
{
  "name": "WordPress",
  "version": "6.8.1",
  "wordpress_core_version": "6.8.1",
  "wp_phpunit_version": "6.8.1"
}
```

### Update Process

1. WordPress releases new version (e.g., 6.8.2)
2. Update composer.json to require `"wp-phpunit/wp-phpunit": "^6.8.2"`
3. Update version in wordpress.json to "6.8.2"
4. Users run: `homeboy module update wordpress`
5. Module runs `composer update` → new WordPress installed
6. All projects now test and lint against new WordPress version

---

## 12. Implementation Status

### ✅ Phase 1: Module Infrastructure (COMPLETE)

| Task | File | Status |
|------|------|--------|
| Create composer.json with wp-phpunit | composer.json | ✅ Complete |
| Create composer.json with PHPCS | composer.json | ✅ Complete |
| Add `composer lint` script | composer.json | ✅ Complete |
| Create scripts/setup.sh | scripts/setup.sh | ✅ Complete |
| Create scripts/test-runner.sh | scripts/test-runner.sh | ✅ Complete |
| Create scripts/generate-config.sh | scripts/generate-config.sh | ✅ Complete |
| Create tests/bootstrap.php | tests/bootstrap.php | ✅ Complete |
| Create phpunit.xml.dist | phpunit.xml.dist | ✅ Complete |
| Create phpcs.xml.dist | phpcs.xml.dist | ✅ Complete |
| Create SQLite driver | sqlitedb/db.php | ✅ Complete |

### ✅ Phase 2: Module Manifest (COMPLETE)

| Task | File | Status |
|------|------|--------|
| Add runtime section | wordpress.json | ✅ Complete |
| Add testing section | wordpress.json | ✅ Complete |
| Add settings array | wordpress.json | ✅ Complete |
| Add wp-test command | wordpress.json | ✅ Complete |
| Module ready check | wordpress.json | ✅ Complete |

### ✅ Phase 3: PHPCS Linting (COMPLETE)

| Task | Status |
|------|--------|
| Add PHPCS dependencies | ✅ Complete |
| Add `composer lint` script | ✅ Complete |
| Create universal phpcs.xml.dist | ✅ Complete |
| Update test-runner.sh for PHPCS | ✅ Complete |
| Project-level linting support | ✅ Complete |
| Component-level linting support | ✅ Complete |

### ✅ Phase 4: Test Execution (COMPLETE)

| Task | Status |
|------|--------|
| Component-level testing | ✅ Complete |
| Project-level testing | ✅ Complete |
| PHPUnit only when tests exist | ✅ Complete |
| Per-component reporting | ✅ Complete |

---

## 13. Benefits Summary

### Testing
✅ **Zero WordPress infrastructure in projects** - No wp-config.php, no database setup, no WordPress installation
✅ **Universal testing** - One WordPress installation serves all projects
✅ **Zero-config** - SQLite in-memory database, no setup needed
✅ **Fast** - No database server, in-memory database
✅ **Consistent** - All projects test against same WordPress version
✅ **Version controlled** - Module updates update WordPress centrally
✅ **Build integration** - Automatic testing during builds

### Linting
✅ **Universal standards** - All projects use same coding standards (WPCS)
✅ **Zero-config** - PHPCS provided by module, no setup needed
✅ **Project-level linting** - Lint all components in project at once
✅ **Fail-fast** - Catch issues before running tests
✅ **No PHPCS in projects** - Module provides all PHPCS packages
✅ **Universal config** - Same rules for everyone

### Platform
✅ **Platform offering** - Homeboy provides complete development infrastructure
✅ **Platform-agnostic** - Homeboy Core provides JSON only; modules parse settings themselves
✅ **Single source of truth** - WordPress, PHPUnit, PHPCS all from module

---

## 14. FAQ

### Testing Questions

**Q: Do I need to install WordPress in each project?**
A: No. The WordPress module provides WordPress centrally. Projects only need test files.

**Q: How do I specify which WordPress version to test against?**
A: The WordPress module version determines the WordPress test version. Update the module to test against new WordPress versions.

**Q: Can I use MySQL instead of SQLite?**
A: Yes. Configure it via module settings: `homeboy config set modules.wordpress.database_type mysql`

**Q: Do I need a wp-config.php in my project?**
A: No. The module generates a temporary wp-config.php during test execution.

**Q: How does database cleanup work?**
A: SQLite in-memory database is automatically freed when tests complete. MySQL database is reset via the test suite.

**Q: Can I test against multiple WordPress versions?**
A: Currently not supported (per KISS principle). Module version = WordPress version.

**Q: What if my plugin requires other plugins to be active?**
A: Add those plugins to test bootstrap via `tests_add_filter('muplugins_loaded', ...)`

**Q: Does this work for themes too?**
A: Yes. The test bootstrap will look for style.css with "Theme Name:" header and load it similarly.

### Linting Questions

**Q: Do I need PHPCS in my project?**
A: No. The WordPress module provides PHPCS and all standards. Just run `composer lint`.

**Q: Do I need phpcs.xml in my project?**
A: No. The module provides a universal phpcs.xml.dist with WordPress standards.

**Q: Can I customize PHPCS rules for my project?**
A: Currently no (per KISS principle). Universal standards ensure consistency across all projects.

**Q: What coding standards are used?**
A: WordPress Coding Standards (WPCS) - the official standard for WordPress development.

**Q: How do I lint all components in a project?**
A: Run `homeboy test <project-id>` - it lints all components then runs tests on those with tests.

**Q: What if my project doesn't have tests?**
A: It will still be linted. PHPUnit is skipped if no `tests/` directory exists.

**Q: Can I run just linting without tests?**
A: Run `composer lint` in any WordPress project - it will use the module's PHPCS.

### Architecture Questions

**Q: Why use jq to parse JSON instead of individual env vars?**
A: Homeboy Core must remain platform-agnostic. Providing individual HOMEBOY_SETTINGS_* vars assumes module-specific patterns. Modules are responsible for parsing their own settings.

**Q: Why single source of truth?**
A: Eliminates duplication, ensures consistency, simplifies maintenance, and provides a centralized upgrade path for WordPress, PHPUnit, and PHPCS.

**Q: Can I use my own PHPUnit or PHPCS?**
A: No (per KISS principle). The module provides everything. If you need custom infrastructure, you're on your own.

**Q: What about CI/CD integration?**
A: Simply run `composer lint` and `composer test` in your CI pipeline. The module provides all infrastructure.

---

## 15. Architectural Notes

### Homeboy Core Responsibilities
- Provide `HOMEBOY_SETTINGS_JSON` as a single JSON string
- Provide generic context vars: HOMEBOY_MODULE_PATH, HOMEBOY_PROJECT_PATH, HOMEBOY_COMPONENT_ID, HOMEBOY_COMPONENT_PATH
- Remain completely agnostic to module implementation details
- Execute module runtime scripts

### Module Responsibilities
- Parse `HOMEBOY_SETTINGS_JSON` using tools like jq
- Extract settings needed for module-specific behavior
- Implement all platform-specific logic within module boundaries
- Handle database configuration, WordPress specifics, PHPCS configuration
- Provide universal PHPCS standards and configuration
- Support both component-level and project-level operations

### Anti-Patterns to Avoid
- Homeboy Core expanding individual settings as `HOMEBOY_SETTINGS_*`
- Modules assuming platform-specific env vars exist
- Tight coupling between Homeboy Core and any specific module
- Projects managing their own PHPCS configuration or packages
- Duplicating WordPress, PHPUnit, or PHPCS infrastructure in projects

### Separation of Concerns
This separation ensures:
- Any module can use the same Homeboy Core
- Homeboy Core remains simple and maintainable
- Modules can evolve independently
- Platform-specific concerns stay within modules
- Projects focus on code, not infrastructure
- Universal standards and tooling across all projects

---

## 16. Future Enhancements

### Potential Future Features
- Support for testing against multiple WordPress versions
- PHPCS rule customization per project (if demand exists)
- Static analysis integration (PHPStan, Psalm)
- Coverage reporting
- Performance testing integration

### Principles for Future Work
- Maintain KISS principle
- Keep universal infrastructure in module
- Avoid project-level duplication
- Prioritize consistency over flexibility
